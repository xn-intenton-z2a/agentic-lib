# Agentic Handler

## Value Proposition
- Provides a streamlined integration point for AI-driven automation by invoking AI reasoning during event processing.
- Enhances the digest pipeline with context-aware suggestions and action plans generated by OpenAI, reducing manual intervention.
- Offers both HTTP and CLI interfaces to invoke agentic workflows, enabling flexible integration in serverless functions and command-line environments.

## Success Criteria & Requirements
- Expose an async function `agenticHandler` that accepts an object with headers and JSON body.
- Detect event type by inspecting `X-Github-Event` header and `body.event` for `workflow_call` events.
- For `workflow_call` events, extract workflow name, action, inputs, and repository context.
- Build a chat prompt combining event metadata and inputs.
- Use OpenAI `createChatCompletion` with system and user messages to generate a structured JSON plan.
- Parse the AI response into an `aiPlan` object and attach it to the digest payload.
- Create an SQS event via `createSQSEventFromDigest` and invoke `digestLambdaHandler` with the enriched digest.
- Emit structured logs for the request, AI invocation, AI response, and final dispatch.
- Return an HTTP response object with `statusCode` 200 and a body containing the `aiPlan` and dispatch confirmation, or an error `statusCode` and detailed error body on failure.
- **New**: Extend CLI in `sandbox/source/main.js` with a `--agentic` flag that:
  - Reads a complete event JSON from standard input.
  - Invokes `agenticHandler` with parsed headers and body.
  - Outputs the handler result to standard output as JSON.

## Usage Examples

### HTTP Framework Invocation
Import and use within an HTTP framework or serverless function:

const { agenticHandler } = require('@xn-intenton-z2a/agentic-lib');

async function handler(req, res) {
  const result = await agenticHandler({ headers: req.headers, body: req.body });
  res.status(result.statusCode).send(result.body);
}

### CLI Invocation
Run from the command line by piping a GitHub event JSON into the CLI:

echo '{"headers": {"x-github-event": "workflow_call"}, "body": {"event": "workflow_call", ...}}' | node sandbox/source/main.js --agentic

## Verification & Acceptance
- Unit tests cover valid event conversions, AI invocation with mocked OpenAI, and correct HTTP response formatting.
- New tests verify CLI invocation with `--agentic`: mocking stdin and capturing stdout to assert correct handler invocation and JSON output.
- Simulate missing OpenAI API key, invalid chat response format, and malformed events to assert appropriate error codes, logs, and CLI exit behavior.
- Tests verify that `aiPlan` is included in the digest for `workflow_call` events and dispatched properly via SQS.
- Code adheres to ESM standards, runs on Node 20+, and passes lint and formatting rules.