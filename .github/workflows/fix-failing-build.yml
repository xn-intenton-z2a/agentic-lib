# .github/workflows/fix-failing-build.yml
name: Fix Failing Build
run-name: "Fix Failing Build [${{ github.ref_name }}]"

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'The target file to fix. e.g. "src/lib/main.js"'
        type: string
        required: false
        default: 'src/lib/main.js'
    #schedule:
    # Run every 10 minutes (as an example)
    #- cron: '0,10,20,30,40,50 * * * *'
    #- cron: '0 * * * *'

jobs:

  fix-failing-build:
    permissions:
      contents: write
      issues: write
      id-token: write
    uses: './.github/workflows/wfr-fix-failing-build.yml'
    with:
      target: ${{ inputs.target || 'src/lib/main.js' }}
      branch: 'issue-failing-build'
      buildScript: 'npm run build'
      testScript: 'npm test'
      mainScript: 'node src/lib/main.js'
      model: 'o3-mini'
      gitUserEmail: 'action@github.com'
      gitUserName: 'GitHub Actions[bot]'
    secrets:
      PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      CHATGPT_API_SECRET_KEY: ${{ secrets.CHATGPT_API_SECRET_KEY }}

  create-pr:
    needs:
      - fix-failing-build
    if: ${{ needs.fix-failing-build.outputs.fixApplied == 'true' }}
    permissions:
      contents: write
      packages: write
      id-token: write
    uses: './.github/workflows/wfr-create-pr.yml'
    with:
      branch: 'issue-failing-build'
      baseBranch: 'main'
      commit-message: 'Fix ready for failing build'
      label: 'automerge'
    secrets:
      PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
