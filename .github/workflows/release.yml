# .github/workflows/release.yml
#
# Deliberate release workflow for agentic-lib: test → tag → npm publish → rotate.
# Manual dispatch only — no automatic triggers.
# Does NOT depend on wfr-* workflows or template workflows.

name: release
concurrency: agentic-lib-release
run-name: 'release ${{ inputs.versionIncrement }} [${{ github.ref_name }}]'

on:
  workflow_dispatch:
    inputs:
      versionIncrement:
        description: 'Semantic version increment'
        required: true
        default: 'prerelease'
        type: choice
        options:
          - prerelease
          - patch
          - minor
          - major
          - premajor
          - preminor
          - prepatch

env:
  npmAuthOrganisation: '@xn-intenton-z2a'
  gitUserEmail: 'action@github.com'
  gitUserName: 'GitHub Actions[bot]'

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Set up ~/.npmrc
        shell: bash
        run: |
          echo "${{ env.npmAuthOrganisation }}:registry=https://npm.pkg.github.com" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.PERSONAL_ACCESS_TOKEN }}" >> ~/.npmrc
          echo "always-auth=true" >> ~/.npmrc

      - run: npm ci || npm install
      - run: npm test

  publish-npm:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    env:
      versionIncrement: ${{ inputs.versionIncrement || 'prerelease' }}
      buildScript: 'npm run build'
      releaseNotes: 'Release increment: ${{ inputs.versionIncrement }}.'
    outputs:
      releasedVersion: ${{ steps.released.outputs.releasedVersion }}
      newVersion: ${{ steps.rotated.outputs.newVersion }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Set up .npmrc for install (PAT)
        shell: bash
        run: |
          echo "${{ env.npmAuthOrganisation }}:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.PERSONAL_ACCESS_TOKEN || secrets.GITHUB_TOKEN }}" >> .npmrc
          echo "always-auth=true" >> .npmrc

      - run: npm ci || npm install

      - name: Set up .npmrc for publish (GITHUB_TOKEN)
        shell: bash
        run: |
          echo "${{ env.npmAuthOrganisation }}:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc
          echo "always-auth=true" >> .npmrc

      - name: Build
        run: ${{ env.buildScript }}

      - name: Configure git
        run: |
          git config --local user.email '${{ env.gitUserEmail }}'
          git config --local user.name '${{ env.gitUserName }}'
          git config --local pull.ff false
          git config --local pull.rebase false

      - name: Get latest from remote
        run: |
          git fetch origin ${{ github.ref_name }}
          git merge origin/${{ github.ref_name }} --no-ff --no-edit --strategy=recursive --strategy-option=ours

      - name: Publish release
        id: released
        if: env.versionIncrement == 'major' || env.versionIncrement == 'minor' || env.versionIncrement == 'patch'
        shell: bash
        run: |
          unset PERSONAL_ACCESS_TOKEN
          npm version ${{ env.versionIncrement }}
          ${{ env.buildScript }}
          npm publish --tag latest --access restricted
          git push --follow-tags
          releasedVersion=$(node -p "require('./package.json').version")
          echo "releasedVersion=${releasedVersion}" >> $GITHUB_OUTPUT
          echo "releasedVersion=${releasedVersion}"

      - name: Create GitHub Release
        if: env.versionIncrement == 'major' || env.versionIncrement == 'minor' || env.versionIncrement == 'patch'
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.released.outputs.releasedVersion }}
          name: Release ${{ steps.released.outputs.releasedVersion }}
          body: ${{ env.releaseNotes }}

      - name: Rotate to next prepatch version from a released version
        if: env.versionIncrement == 'major' || env.versionIncrement == 'minor' || env.versionIncrement == 'patch'
        shell: bash
        run: npm version --no-git-tag-version prepatch

      - name: Rotate to next pre-release version
        if: env.versionIncrement == 'premajor' || env.versionIncrement == 'preminor' || env.versionIncrement == 'prepatch' || env.versionIncrement == 'prerelease'
        shell: bash
        run: npm version --no-git-tag-version ${{ env.versionIncrement }}

      - name: Record rotated version
        id: rotated
        shell: bash
        run: |
          newVersion=$(node -p "require('./package.json').version")
          echo "newVersion=${newVersion}" >> $GITHUB_OUTPUT
          echo "newVersion=${newVersion}"

      - name: Build after version bump
        run: ${{ env.buildScript }}

      - name: Push version commit
        shell: bash
        run: |
          git add -v --all
          newVersion=$(node -p "require('./package.json').version")
          git commit -m "${newVersion?}"
          git push origin HEAD

      - name: Tear down .npmrc
        shell: bash
        run: rm -f .npmrc

      - name: Log final version
        shell: bash
        run: echo "Final version ${{ steps.rotated.outputs.newVersion }}"
